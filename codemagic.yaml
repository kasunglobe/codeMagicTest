# Check out https://docs.codemagic.io/yaml/building-a-react-native-app/ for more information
# Please review and update values

workflows:
    react-native-android:
        name: React Native Android
        max_build_duration: 120
        instance_type: mac_mini
        environment:
            vars:
                GCLOUD_SERVICE_ACCOUNT_CREDENTIALS: Encrypted(...) # <-- Put encrypted CONTENTS of your Gloud crendentials file here
                PACKAGE_NAME: "com.kasunv.codemagictest" # <-- Put your package name here e.g. com.domain.myapp
                CM_KEYSTORE: Encrypted(Z0FBQUFBQmc3cjVXdUMtQlB1SlVJNlREOWx5dk9QZ3FOVUxxWVlremwtVjRMR3NvdUpSYW4tZDRyYVI4TFZsMGNSS3NDdWg3SnBKNTRseHR5eUdhRm53M3NiQTZuaEJlMUVXZ1RaQmtZQ3VCZmhHdDZpVEFuYk1SbGpia2tkYWFkdDJDay1EMkpxRDFsc1lXNldwQ1FNVWZDdnlORGIzZEw3VlpMcnAzWk1rdnV2dXh2RXFfY2MtQVNDcVBpdDN5aWdpQXJYLVFmdG1PR0hJWTljV0VBWUpSZDFrNl85a29CcXFLVWtZUVZ5Nk0zbkdjUU5SN201anAxZlhyT0F6Y2JzUUVOaGNxQnhjY3QwTy1OTmxhcEZpczhiQ014TUt3VXVzYkNUWkszemNscVZqUFlTV1F3Y2FUMllHVC1leVlrVFRfdk9idUN5eDJ3bjNBLUVaZnFOWTZKUVNhaTNyb2pSMEhOM1ZpVlgzWFhWTjByclRkOUNmSy1ZQTZQZkJ3ZEJLMHh4Y2g2S0FZdmFKUTJwY21xVmtnSUxOMlBlbG5jY3RZalRRNTBXZTlxTlVoc3NPN29uZFNCems2Y3RVQkxCMmszMmZQdnotNFlQNmgxUVdBcHZwaTF1d2hlalk5bThIeG1HYmkySGhUU1FxdHduS2xyd3ZaUHBtU081bV8yWHBHZXB0bHVnb05Bc3RzbjNfWFR6amJIMXU0S2hRa0FDSk9fckVqeTlrRnlTbGpMVC1GNk80a2lPWjlsSzctdFYzWDNpQldldXcwLVpMdXk5YVFTMTlIaHkwU0x5UXpDYjJpcmx4cEFjaU52NENlZU15eDVELUtUSXJTeWI5ckFldGFiSndSRUk2VEpMUTN1dWVtQnptWTc5ZkJENGUxYnRGb3lRSFhYeWNHUXlNV2FqMFNnanpUZTdfdG1UUlQyb2k3TmZMUk55aFJlOHppSTBVNG1Zd2J6N0w2d3c1a2RlNkxwT1RaSi1SSGxUYlo4SUhtenR5cHpmNjVZbF9GSGphXzN4UHQzVFlNancydUljZWpFX0stQlRfdjN1TkxEQl9ZcUd1OE1WS1BQaFdZYmx1TVo1MllyN1Q2Mkt1dDRwRmYyMUxvXzdfeGloVEdwMGdNOTRQTHhpMFUzX2czOER2WVZKcE1yeXF3MXo0M29IYVh2ZDRxSmRGcXBqMlVqckhfY0VTSVVyLWxBSjJBSlpNTEJ4eThMbHJSLWE5a2t0djJLWkE2aHJRTTV4MER5SzIxZktrMFdacG1EajcxSUJSRHVrZG00ajZoQ29raHROWjBVaXFFaEJkbS1RenF0RzNjdGpLUjBWdUVUZVZCanQ1TXljTm01ZUdrdkpEX3plWUg1cUQ1NkwwQ2tDbHd0WnhpRFJJWDRfSjVuZENqV3lGemwzdHZoZDNGZFQzeFdKM2p6WUZ2RnphbW1rcG9UN1ZvZkdjelNiaU92cC1hMXJXdG10WEFFbVZqak1rWC1rY2NFSmpYTXRwcGNPbTZhU1NPOC1aRFhYMGRTc3lWVlp4WHlUR1dLVjgtOGszX1lwNVJPRk9xYkdwTDNqa0dfT1NFbGVtcVBDY0xzNXctOWpCTXZaYWJYc3YybUFNcnotUHdJWE9zUmg0blJXWmNqT3hkSGZkU015bW9mU2M1XzZxVnhjbnN3YlJTS1dnYWhJZWRKWlVfWGVSM2FHRzNzY1BPclVfNG9vTFhacGhGb0U2RUU2Tno1MGVUSHBWRzZEbzFvcHN5OG9nN3NJVDhGcFo2SHRocmVSVnFRNVY0ZDFQbGtUMUF5YnozZlJfZkZxLUZwQnpkbS0zVkthaVEyaHA0MC1UbWVOMGotcGNCSnJjb1J5MzNMRGVGTUJUZmpraEF4V1BCZTNHWDloMkxJZ3FOT1NQcmpuVm1hVVBPYkg3VnZxZ0RnOUxwZGh1SHI4MTVnUjBrcFc3Y1RPcGhaRWl0T0ZwQ2c1czVNdGR5QVpFWEhNWTlVMmp3VDFUYnVtREs3dFppVGlPcjFTamtPVzE5Q1MtNE44RDhHUm5UYlZ0V3hYSUdJUy1XSmRVU2dJbUdrS1BmbnJVWVBDY3YxOTBIY284RkQ5VVV6YWV1RFl2dWMyV3hOa0RWRmdqTUtqNDllOXZTSGVhQkZvbmJVMWVDQlVyYzVMU2VGZXVjbnU0TktOa0xVYldsYTRjX25qOHpKTmllZkw3b3FnZEFXVUt4M1VVVE1DanFuVVBDd19aTHFCRFRjWUg1Z3AzVWZtMTU3b2d0S0pOQlE3eFhFc2E3alMwUjNta29pbEZEd0NHdktveDJJa01jUk9wdVFzblNjQnBnMXJfRnlvdDEtbUxlbXNyc3RyaEF0WnMxT0hDYXNINzRBUXlfWXlKbUd4RUM5cFpVcHNYSllMU25GS1pPLUFQOFk4Z3RPT3F5cU9EaXNnNXZ0SDVnbjRWZVRWZTgzdVJtZWRBV0pobUdhb0h4Ykl5Q0htVV9VbFRHbXllUV80V3l1UElnQTV4Q3dxclZPcUNJSGJLa05WUGVTdUtDQ0taT3pLMjc3TVRaRU92M3I2QjVnZ0RYZWF2VW8tZTZFR1dEZmtDNzk3cU9INWVDQmtXOGtucU5YbUtwQXdRU3dFSGdhOWlsb2dSZGMxa19WWHZaOS1XOUJ3N0JJVWVoenVMLVZzSUJUdm5ySnZwQWNPbHBZRFIwTWZIa0dPdnpxbWpGT19SRHd2Sjc1WWZCbkRucmRxU1VoUDdNaU1hWUl4cnJjX3YxUzAtcEJwaTVwbzZBVUlLYUp0LVRjRDhCSDVaMWlEN29rTDlBNlBiWldLWXpCTHI0Wk44bWdMTFVTUjdXWGU0Rldsa3FlZFZnazc3X25FeTEwMUc0clN2eWE5QXVkUThaWW5XbW9pVkZBQWpmOEZkNEQ2aF9FbC1fcGNnSlVVUWU5Yk1qemVXZnBNRWFkYkx0aGU3UGdmQ0pBdkhHaG9GTlg2cWxHc3RxZm5fWFZDdGNnbmZQU0tlOXFualZzMmg5YzFuRTQzSGs4RG9BNnZ1U2x6Q19kUDJNc2g4SUVhSk03WTZuSEdPaVA4R3d5NXc3ZXZQQ0tBczFkVklwVzRPbFh0S1RHU0t5b0RKY2cyUHZRVUhtSmlxRzRZZGt3aFA0RHRHT0hjbnpvTXZocUVNdllkRUpKQTBjT1puZ2NieC1EWVFJOEZpR3BsNlVEcjdfWlJkNGlINW5DR0Y0cUpENFZhMmw4c1BiRzR5SEhocU84Zk9xRXp1Vl9feWFMejJSbGxxVlZ6RUtKa1Rqekk3Mkd5M1BMMUptQWJEUEhBeXg5clo0bVU2OXFKVDNJVnNQRmx0N3ltRXluQjJ3SW9raHJYTFAwbjFXNVBwVmFrOGxLNXp3X1ZDREp2MXdxTTNjMkVUMXdwbjZzME9qQmt4SXRyX2IzVUx0LTRVZnpaWUZwMVpJZzViQ1l6RlR6cUxDV25GOHpabVk2RXBqaU1JTDc5NEdSdHBXdnctakNpZ0U3WkxWR0dfSFNFLU5rQzZHUlZHNFBIWmRxa0pnMnZKdHRGMFRNZ3ZVU2lNajhlVjlpTGQwcmwxNFFQRm1aME56UkNGeENpeEJDdjRHWlRWRlI1X0Z2dnhLXy0tbHVSamdhc2dxRmpCdmVDOWNwTFpWeVhFclRuV2Uzc1BqZ1VlaW9GUlF0THFlSjU2UVlhclhNcmRiUUtyV2ZRWG42bXpSQl9mTHlBOVFlc0VkZzZsaVBUTUZwWnQtUERyZjVPNTlSMm4zUVdtYkprT195NDBsdktZM2ljWXN4Y0hXcDNFdzZRVjFjVm9mcFE2eXZ3VmE2a0tmN2R2Rk82YUMtZ2RQRkVUbzZDdFFWSDY5R3VxcDRSeGwtLUtvdVNRQUZHWDFwTmNGUVZTek5GMmJqaUtVUWpoWGotako1R3JmT0tEMHd0LUM4MHp1SUZod2lWVDRXbi0yR0tVbjBxZnNCVFR4ZnpmeTFjTnR0SjQxNmVuREU1YlZSOVRjckg3SW5HNzNWOFVUOHhTMEgxblJ6NW9mMnpETlRQdGJaMUNka2pPZjN5MkhMdnJqMjJ5QzJsdzEzdmxlOHpxREF4UjlIZGVDYTFKeUpJcGpUVGpqcUNKODlESXZRUnlzbWcwUWNLOUNUdGVnMjgtdmc3RXNSRHNEaEEtSEc0b3k4aE5FYWxHaWQxaGhnUjBuT3B3SlBzbk03cVUwOENLX3NNVDRuWFhJZzU0U3dpMTAtN2dkUGxEX3o1bkQ0blo2bXl2VElObWtSTXdxZHhQb2htbnhPc0VxVkFhQmhNYWhuWXhuMVA1dnFDNUNaMlpaVnlsU2hPdTJOVTNTUVJ4c0k3cTFjUlFsSUhaWDR5ZzV5bnhLa0twanJQMEFjX3NYZHAwcW9KM3dPSkNJVVdrX3lQZHNMSUdaRmpXSFdmZENOUXFZdDF1MXVHXzdNcUpfdVhNM1BtYjFyZHdkeXl1RmF6cjlYLU1GXzkxbkc5ZXloejVaZF9VSU1mR2lsSHkzaUl0bWxPd1dJQ2Y5RDNwN21pMTZKV1o3QTE5dTF2NkhrSVpfWWxoZFRhVEJmRkNkVXpZeGdZMVBtTUlvYS0xMkYwdVluckhsZ2pPNEFmQUh1SXVLbVpELWt1c19sejRPOFV2eWdiVTdEeEM1N0lrV2ktVFFPMU5PTGRpTElmaDF4X3VVZGhfcVFsU1I1OHB1STJTTkpDX2hsMVZtck9YWVhYc1phSjR6bkxfUDQ1d2ZiejdSYW1sVHRwbk9ESV9ZU3FSbWdxM0JYSE5RbmdDb3k3T0ctNU5HRG1seWlkN0VGRjRFVklYX2xhd1k0NEhrMU5FbkdaNWYyTUpqQmFfZF9rTjNoekV1c3F0UkJneVlHRUZydkN4WXVWY25TbDNoeEw0YUhRa3ZwVEFBd2FuTVl1cDU5eGN3QnZ2d28wUGowUFlGNXFPcDQ3Y0haQjFueE5kX3VObUxhYjhDT0JmQTdrNUZkcHNPMkdWR3V3bUhoOEdmYzBlT2pWeC1kTEtUczUweFZHRnNZbEtvUmVvRjNjSGRPeHJ3WTNiUHh1ajVGR05WalVIbjl4NW12T1EwdlFydEJ6X28wdi10ekx6dHcyeTE0VVM5eUN2b3VDdkh6YWlaZ3JydnpxeTUzc2wtZEdjdzhTaVhlMUU3ZDZvb0s2ZDVYZG5zTWIxU3NsZTdidFk5RWtBMG1uS1dxSFVDejlwM2lINF9yQXQ4ZGZKZ25RaGlYMmpBUW9sNlo4d2MxNS1CRmhKVEVuQjdZbmxnV0xINDdmZm9mMzdmMl8wbHdwMGQyRkpJRklkclBiSjZEZkg3WC1PeVB3MHBLeHNIZW1PaWpOR0VSTTVjYUJ2UXozcENyNmh5bWdxTklMcGFFRVctV3VjSzlFdEZiX3ZMSVJ5RkVabHZzNkFscXZfOE5tUkllWkV6VHRaUE5CX194SGg5QXdWM1FLVzhNemk4YzdnVHYya0ZsZ0FnbFEyMHZxclVyRFRUbV94b1MzN0p0Y2JFTUtlVWt4Ty1SdHlPQWFOT0dVUmpnUS1nVVl1b2R5S0FjWTZfODNFZEg1M1dGTjljSGp0aFZGMm96aWNER3FpNFdKMlg4VnJZb00wcDl3blg0ZThCeGkyTl9IenRYY2UzVTVEYkN1dElPZWtLSXVEeVN6WUlPX3N3eVRRd21JWXgweUNmSzhNRjhtWkpZS25OR1RCNnY2ZWtIclFEVnh3b0g1UVc1UHFINllCREcxZlhhVjR0U29raXBQb0xwUWVQLTQxOVFKQ3JDb1hhU0gwQUlKR0Q4QnBwVTJDZzFMUXVjdTdaOEJldUdPSTZ0dEJKSTVBbGZHWXp3aFh2Wk1SX1hNWXhQWUxWU2J5Ty1fRl9FNS1tdklIOGxSTHV5ZWw5LUZ2aGJ5LU1QZURqZUNSUlhhQjJGU3cwTjFJdDRrcDQ5ZVp5UkRyMGFUMjc4Rnp4bEFyZkZZaWktZ0ROVl9mcVhHbGVVYnI0N2dOZEFpdEozX0djU25URGsyV1VJcklVbzVacU11TFdjd2xvcDE4bXRaRmpTUGttbndVLXpES29jSDBOWHVpSDRCbEdnRTEzUXBWb0FpbTVJZ3BBWjY4QmMydG1lVEFPZzhiV0FELVBWS0xSYTFRQUtSMGJkRWcxUjFxcXhvczFqbGdlOGxPdlRJX3E2amJPZWVUa0pMYkRobGJJQzlJQnk3R0M4eFZvQzI4VA==) # <-- Put your encrypted keystore file here
                CM_KEYSTORE_PASSWORD: Encrypted(Z0FBQUFBQmc3bDJORjRldHNLVUVfSXNscF92Z3BvV2RVcUpMTmJKWXZFUEZjUFQ2clBITmEtNklFaFJOallKamxsbUc1SlBxcW93TUFXWHdJZ2hmdGZyamk4MHN0MV91LWc9PQ==) # <-- Put your encrypted keystore password here
                CM_KEY_ALIAS_PASSWORD: Encrypted(Z0FBQUFBQmc3bDJORjRldHNLVUVfSXNscF92Z3BvV2RVcUpMTmJKWXZFUEZjUFQ2clBITmEtNklFaFJOallKamxsbUc1SlBxcW93TUFXWHdJZ2hmdGZyamk4MHN0MV91LWc9PQ==) # <-- Put your encrypted keystore alias password here
                CM_KEY_ALIAS_USERNAME: Encrypted(Z0FBQUFBQmc3bDNVckhjd2QwcDVwOFhaRTh6Q1ZlRnVRZ0w2RTVCVkxrZXhUcUpSQVZXUXc1cGZ4RzBjWnh2eW5ZQnlxSWVyVWxrWG1aMGI3bzdreXA0N1d0XzdyR192bHc9PQ==) # <-- Put your encrypted keystore alias username here 
            node: latest
        triggering:
            events:
                - push
                - tag
                - pull_request
            branch_patterns:
                - pattern: develop
                  include: true
                  source: true
        scripts:
            - name: Install npm dependencies
              script: |
                npm install
            - name: Set Android SDK location
              script: |
                echo "sdk.dir=$ANDROID_SDK_ROOT" > "$FCI_BUILD_DIR/android/local.properties"
            - name: Set up keystore
              script: |
                    echo $CM_KEYSTORE | base64 --decode > /tmp/keystore.keystore
                    cat >> "$FCI_BUILD_DIR/android/key.properties" <<EOF
                    storePassword=$CM_KEYSTORE_PASSWORD
                    keyPassword=$CM_KEY_ALIAS_PASSWORD
                    keyAlias=$CM_KEY_ALIAS_USERNAME
                    storeFile=/tmp/keystore.keystore
                    EOF               
            - name: Build Android release
              script: |
                # Set environment variable so it can be used to increment build number in android/app/build.gradle
                # Note that tracks can be specified when retrieving latest build number from Google Play, for example:
                # export NEW_BUILD_NUMBER=$(($(google-play get-latest-build-number --package-name "$PACKAGE_NAME" --tracks=alpha) + 1))
                export NEW_BUILD_NUMBER=$(($(google-play get-latest-build-number --package-name "$PACKAGE_NAME") + 1))
                cd android && ./gradlew assembleRelease
        artifacts:
            - android/app/build/outputs/**/*.apk
        publishing:
            # See the following link for details about email publishing - https://docs.codemagic.io/publishing-yaml/distribution/#email
            email:
                recipients:
                    - kasunglobe@gmail.com
                notify:
                  success: true     # To not receive a notification when a build succeeds
                  failure: false    # To not receive a notification when a build fails
            slack: 
              # See the following link about how to connect your Slack account - https://docs.codemagic.io/publishing-yaml/distribution/#slack
              channel: '#channel-name'
              notify_on_build_start: true   # To receive a notification when a build starts
              notify:
                success: true               # To not receive a notification when a build succeeds
                failure: false              # To not receive a notification when a build fails
            google_play:
              # See the following link for information regarding publishing to Google Play - https://docs.codemagic.io/publishing-yaml/distribution/#google-play
              credentials: Encrypted(...) # <-- Put your encrypted google-services.json here
              track: alpha
    react-native-ios:
        name: React Native iOS
        max_build_duration: 120
        instance_type: mac_mini
        environment:
            vars:
                # Env vars for automatic iOS code signing
                # See the following link for more details - https://docs.codemagic.io/code-signing-yaml/signing-ios/
                XCODE_WORKSPACE: "ios/YOUR_WORKSPACE_NAME.xcworkspace" # <-- Put the name of your Xcode workspace here
                XCODE_SCHEME: "YOUR_SCHEME_NAME" # <-- Put the name of your Xcode scheme here
                APPLE_ID: Encrypted(...) # <-- Put you encrypted Apple ID here
                APP_SPECIFIC_PASSWORD: Encrypted(...) # <-- Put your encrypted App Specific Password here. For more information visit: https://support.apple.com/en-us/HT204397
                # https://appstoreconnect.apple.com/access/api
                APP_STORE_CONNECT_ISSUER_ID: Encrypted(...) # <-- Put your App Store Connect Issuer Id here
                APP_STORE_CONNECT_KEY_IDENTIFIER: Encrypted(...) # <-- Put your App Store Connect Key Identifier here
                APP_STORE_CONNECT_PRIVATE_KEY: Encrypted(...) # <-- Put your App Store Connect Private Key here
                CERTIFICATE_PRIVATE_KEY: Encrypted(...) # <-- Put your Certificate Private key here
                BUNDLE_ID: "YOUR_BUNDLE_ID_HERE" # <-- Put your Bundle Id here e.g com.domain.myapp
                APP_STORE_APP_ID: 1555555551 # <-- Put the app id number here. This is found in App Store Connect > App > General > App Information
            node: latest
            xcode: 12.5
            cocoapods: default
        triggering:
            events:
                - push
                - tag
                - pull_request
            branch_patterns:
                - pattern: develop
                  include: true
                  source: true
        scripts:
            - name: Install npm dependencies
              script: |
                npm install
            - name: Install CocoaPods dependencies
              script: |
                cd ios && pod install
            - name: Set up keychain to be used for codesigning using Codemagic CLI 'keychain' command
              script: |
                keychain initialize
            - name: Fetch signing files
              script: |
                # For information about Codemagic CLI commands visit: https://github.com/codemagic-ci-cd/cli-tools/blob/master/docs/app-store-connect/README.md
                # For details about the --type paramater below - https://github.com/codemagic-ci-cd/cli-tools/blob/master/docs/app-store-connect/fetch-signing-files.md#--typeios_app_adhoc--ios_app_development--ios_app_inhouse--ios_app_store--mac_app_development--mac_app_direct--mac_app_store--mac_catalyst_app_development--mac_catalyst_app_direct--mac_catalyst_app_store--tvos_app_adhoc--tvos_app_development--tvos_app_inhouse--tvos_app_store
                app-store-connect fetch-signing-files "$BUNDLE_ID" --type IOS_APP_STORE --create
            - name: Use system default keychain
              script: |
                keychain add-certificates
            - name: Increment build number
              script: |
                #!/bin/sh
                set -e
                set -x
                cd $FCI_BUILD_DIR/ios
                # agvtool new-version -all $(($BUILD_NUMBER + 1))
                agvtool new-version -all $(($(app-store-connect get-latest-testflight-build-number "$APP_STORE_APP_ID") + 1))
            - name: Set up code signing settings on Xcode project
              script: |
                xcode-project use-profiles --warn-only
            - name: Build ipa for distribution
              script: |
                xcode-project build-ipa --workspace "$FCI_BUILD_DIR/ios/$XCODE_WORKSPACE" --scheme "$XCODE_SCHEME" 
        artifacts:
            - build/ios/ipa/*.ipa
            - /tmp/xcodebuild_logs/*.log
            - $HOME/Library/Developer/Xcode/DerivedData/**/Build/**/*.app
            - $HOME/Library/Developer/Xcode/DerivedData/**/Build/**/*.dSYM
        publishing:
          # See the following link for details about email publishing - https://docs.codemagic.io/publishing-yaml/distribution/#email
          email:
            recipients:
              - user_1@example.com
              - user_2@example.com
            notify:
              success: true     # To not receive a notification when a build succeeds
              failure: false    # To not receive a notification when a build fails
          slack: 
            # See the following link about how to connect your Slack account - https://docs.codemagic.io/publishing-yaml/distribution/#slack
            channel: '#channel-name'
            notify_on_build_start: true   # To receive a notification when a build starts
            notify:
              success: true               # To not receive a notification when a build succeeds
              failure: false              # To not receive a notification when a build fails
          app_store_connect:                 
              apple_id: $APPLE_ID
              password: $APP_SPECIFIC_PASSWORD
    